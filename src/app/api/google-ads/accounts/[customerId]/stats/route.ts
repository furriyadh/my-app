import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';

// Ø¯Ø§Ù„Ø© Ù„ØªØ¬Ø¯ÙŠØ¯ access token
async function refreshAccessToken(refreshToken: string): Promise<string | null> {
  try {
    console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¬Ø¯ÙŠØ¯ access token...');
    const response = await fetch('https://oauth2.googleapis.com/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        client_id: process.env.GOOGLE_ADS_CLIENT_ID || '',
        client_secret: process.env.GOOGLE_ADS_CLIENT_SECRET || '',
        refresh_token: refreshToken,
        grant_type: 'refresh_token'
      })
    });
    if (response.ok) {
      const data = await response.json();
      console.log('âœ… ØªÙ… ØªØ¬Ø¯ÙŠØ¯ access token Ø¨Ù†Ø¬Ø§Ø­');
      return data.access_token;
    }
    console.error('âŒ ÙØ´Ù„ ØªØ¬Ø¯ÙŠØ¯ token:', response.status);
    return null;
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¬Ø¯ÙŠØ¯ token:', error);
    return null;
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Access Token - ØªØ³ØªØ®Ø¯Ù… MCC Token Ø£ÙˆÙ„Ø§Ù‹
async function getValidAccessToken(userRefreshToken?: string): Promise<string | null> {
  // 1. Ø£ÙˆÙ„Ø§Ù‹: Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… MCC refresh token Ù…Ù† Ø§Ù„Ø¨ÙŠØ¦Ø© (Ø§Ù„Ø£ÙØ¶Ù„)
  const mccRefreshToken = process.env.GOOGLE_ADS_REFRESH_TOKEN;
  
  if (mccRefreshToken) {
    console.log('ğŸ”‘ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… MCC Token Ù…Ù† Ø§Ù„Ø¨ÙŠØ¦Ø©...');
    const mccAccessToken = await refreshAccessToken(mccRefreshToken);
    if (mccAccessToken) {
      console.log('âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ MCC Access Token Ø¨Ù†Ø¬Ø§Ø­');
      return mccAccessToken;
    }
    console.warn('âš ï¸ ÙØ´Ù„ MCC TokenØŒ Ø³Ù†Ø­Ø§ÙˆÙ„ User Token...');
  }
  
  // 2. Ø«Ø§Ù†ÙŠØ§Ù‹: Ù†Ø­Ø§ÙˆÙ„ User OAuth Token ÙƒÙ€ fallback
  if (userRefreshToken) {
    console.log('ğŸ”‘ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… User OAuth Token...');
    const userAccessToken = await refreshAccessToken(userRefreshToken);
    if (userAccessToken) {
      console.log('âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ User Access Token Ø¨Ù†Ø¬Ø§Ø­');
      return userAccessToken;
    }
  }
  
  console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙŠ Access Token ØµØ§Ù„Ø­');
  return null;
}

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ customerId: string }> }
) {
  try {
    const { customerId } = await params;
    
    console.log(`ğŸ“Š Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ ${customerId}...`);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„
    if (!customerId || !customerId.match(/^\d{10}$/)) {
      return NextResponse.json({
        success: false,
        error: 'Invalid customer ID format',
        message: 'Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 10 Ø£Ø±Ù‚Ø§Ù…'
      }, { status: 400 });
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ refresh token Ù…Ù† cookies
    const cookieStore = await cookies();
    const userRefreshToken = cookieStore.get('oauth_refresh_token')?.value;
    
    // ğŸ”‘ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Access Token - MCC Ø£ÙˆÙ„Ø§Ù‹
    const accessToken = await getValidAccessToken(userRefreshToken);
    
    if (!accessToken) {
      return NextResponse.json({
        success: false,
        error: 'No access token available',
        message: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² ÙˆØµÙˆÙ„ ØµØ§Ù„Ø­'
      }, { status: 401 });
    }
    
    // Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Google Ads API
    try {
      const loginCustomerId = (process.env.MCC_LOGIN_CUSTOMER_ID || process.env.GOOGLE_ADS_MCC_ID || '').replace(/-/g, '');
      const developerToken = process.env.GOOGLE_ADS_DEVELOPER_TOKEN || '';
      
      const response = await fetch(`https://googleads.googleapis.com/v21/customers/${customerId}/googleAds:search`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'developer-token': developerToken,
          'login-customer-id': loginCustomerId,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          query: `
            SELECT 
              customer.id,
              customer.descriptive_name,
              customer.currency_code,
              customer.status,
              metrics.impressions,
              metrics.clicks,
              metrics.cost_micros,
              metrics.conversions
            FROM customer
            WHERE segments.date DURING LAST_30_DAYS
          `
        }),
        signal: AbortSignal.timeout(15000)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`âŒ Google Ads API error: ${response.status}`, errorText);
        
        // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
        if (response.status === 403) {
          return NextResponse.json({
            success: false,
            error: 'PERMISSION_DENIED',
            message: 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ØªØ§Ø­ Ù…Ù† MCC Ø§Ù„Ø­Ø§Ù„ÙŠ'
          }, { status: 200 }); // Ù†Ø±Ø¬Ø¹ 200 Ù„Ø£Ù† Ù‡Ø°Ø§ Ù„ÙŠØ³ Ø®Ø·Ø£ ÙÙ†ÙŠ
        }
        
        return NextResponse.json({
          success: false,
          error: `API error: ${response.status}`,
          message: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Ads'
        }, { status: response.status });
      }
      
      const data = await response.json();
      const results = data.results || [];
      
      if (results.length === 0) {
        return NextResponse.json({
          success: true,
          customer_id: customerId,
          stats: {
            impressions: 0,
            clicks: 0,
            cost: 0,
            conversions: 0
          },
          message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©'
        });
      }
      
      // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      let totalImpressions = 0;
      let totalClicks = 0;
      let totalCost = 0;
      let totalConversions = 0;
      
      for (const row of results) {
        const metrics = row.metrics || {};
        totalImpressions += parseInt(metrics.impressions || '0', 10);
        totalClicks += parseInt(metrics.clicks || '0', 10);
        totalCost += parseFloat(metrics.costMicros || '0') / 1000000;
        totalConversions += parseFloat(metrics.conversions || '0');
      }
      
      const customerInfo = results[0]?.customer || {};
      
      console.log(`ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ ${customerId}: impressions=${totalImpressions}, clicks=${totalClicks}`);
      
      return NextResponse.json({
        success: true,
        customer_id: customerId,
        customer_name: customerInfo.descriptiveName || `Account ${customerId}`,
        currency: customerInfo.currencyCode || 'USD',
        status: customerInfo.status || 'UNKNOWN',
        stats: {
          impressions: totalImpressions,
          clicks: totalClicks,
          cost: Math.round(totalCost * 100) / 100,
          conversions: Math.round(totalConversions * 100) / 100,
          ctr: totalImpressions > 0 ? Math.round((totalClicks / totalImpressions) * 10000) / 100 : 0
        }
      });
      
    } catch (apiError) {
      console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Ads API:`, apiError);
      return NextResponse.json({
        success: false,
        error: 'API connection error',
        message: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Ads API'
      }, { status: 500 });
    }
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨:', error);
    return NextResponse.json({
      success: false,
      error: 'Internal server error',
      message: 'Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…'
    }, { status: 500 });
  }
}
